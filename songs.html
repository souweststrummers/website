<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Songs - Sou'West Strummers</title>
    <link rel="icon" type="image/x-icon" href="assets/favicon.ico">
    <link rel="stylesheet" href="assets/style.css">
    <script src="assets/site.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    
</head>
<body class="songs-page">
    <div class="navbar">
        <span class="menu-icon" aria-label="Toggle navigation" aria-expanded="false">&#9776;</span>
          <div class="nav-links">
            <a class="nav-item" href="index.html">Home</a>
            <a class="nav-item" href="songs.html">Songs</a>
            <a class="nav-item" href="events.html">Events</a>
            <a class="nav-item" href="library.html">Library</a>
        </div>

    </div>
    <div class="banner"></div>

    <main>
        <div class="page-header">
            <h1><i class="fa-solid fa-music"></i> Songs</h1>
            <div class="search-row">
                <label class="search-bar" for="songSearch">
                    <i class="fa-solid fa-magnifying-glass" aria-hidden="true"></i>
                    <input id="songSearch" type="search" placeholder="Search by title, artist or genre" aria-label="Search songs">
                </label>
                <div class="view-toggle" role="group" aria-label="Change song layout">
                    <button id="listView" type="button" class="active" title="Show list view">
                        <i class="fa-solid fa-list" aria-hidden="true"></i>
                        <span>List</span>
                    </button>
                    <button id="gridView" type="button" title="Show grid view">
                        <i class="fa-solid fa-border-all" aria-hidden="true"></i>
                        <span>Grid</span>
                    </button>
                </div>
                <div class="search-actions" aria-label="Search helpers">
                    <button id="clearSearch" class="icon-button" type="button" title="Clear search">
                        <i class="fa-solid fa-xmark" aria-hidden="true"></i>
                        <span class="sr-only">Clear search</span>
                    </button>
                    <button id="randomSong" class="icon-button" type="button" title="Random song">
                        <i class="fa-solid fa-dice" aria-hidden="true"></i>
                        <span class="sr-only">Play a random song</span>
                    </button>
                </div>
                <div class="cart-wrapper">
                    <button id="cartToggle" class="btn-white cart-toggle" type="button">
                        <i class="fa-solid fa-cart-shopping" aria-hidden="true"></i>
                        <span>Cart</span>
                        <span class="cart-count" aria-live="polite">0</span>
                    </button>
                    <div id="cartPanel" class="cart-panel" hidden>
                        <div class="cart-items" id="cartItems"></div>
                        <div class="cart-summary">
                            <strong>Checkout</strong>
                            <form id="checkoutForm" class="checkout-form">
                                <label for="contactName">Name
                                    <input id="contactName" name="contactName" type="text" autocomplete="name" required>
                                </label>
                                <label for="contactEmail">Email
                                    <input id="contactEmail" name="contactEmail" type="email" autocomplete="email" required>
                                </label>
                                <label for="contactPhone">Phone
                                    <input id="contactPhone" name="contactPhone" type="tel" autocomplete="tel">
                                </label>
                                <label for="shippingDetails">Shipping details
                                    <textarea id="shippingDetails" name="shippingDetails" placeholder="Address, delivery notes" required></textarea>
                                </label>
                                <button type="submit" class="btn-white" id="submitOrder">Submit order</button>
                            </form>
                            <div class="cart-message" id="cartMessage" aria-live="polite"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="songsList" class="songs-grid" aria-live="polite"></div>
    </main>

    <button id="backToTop"><i class="fa-solid fa-angle-up"></i> Back to Top</button>

    <script src="assets/songs-data.js"></script>
    <script>
        const STORAGE_KEY = 'songLastClicked';
        const CART_KEY = 'songCart';
        const VIEW_MODE_KEY = 'songsViewMode';

        const songs = songsData;
        let viewMode = 'list';
        let cart = loadStoredObject(CART_KEY);

        function loadStoredObject(key) {
            try {
                const stored = localStorage.getItem(key);
                return stored ? JSON.parse(stored) : {};
            } catch (error) {
                console.error('Unable to parse localStorage entry', error);
                return {};
            }
        }

        function loadStoredString(key, fallback) {
            try {
                const stored = localStorage.getItem(key);
                return stored || fallback;
            } catch (error) {
                console.error('Unable to read localStorage entry', error);
                return fallback;
            }
        }

        function saveStoredObject(key, value) {
            localStorage.setItem(key, JSON.stringify(value));
        }

        function formatWeekDescription(timestamp) {
            const now = new Date();
            const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            const clickedDate = new Date(timestamp);
            const clickedDay = new Date(clickedDate.getFullYear(), clickedDate.getMonth(), clickedDate.getDate());
            const diffInMs = today - clickedDay;
            const diffInWeeks = Math.floor(diffInMs / (7 * 24 * 60 * 60 * 1000));

            if (diffInMs === 0) return 'Today';
            if (diffInWeeks <= 0) return 'This week';
            if (diffInWeeks === 1) return 'Last week';
            return `${diffInWeeks} weeks ago`;
        }

        function formatDateOnly(timestamp) {
            return new Date(timestamp).toLocaleDateString(undefined, {
                month: 'short',
                day: 'numeric',
                year: 'numeric'
            });
        }

        function formatYoutubeLink(title, artist) {
            const searchTerm = artist ? `${title} ${artist}` : title;
            const query = encodeURIComponent(`${searchTerm} site:youtube.com`);
            return `https://www.google.com/search?q=${query}&btnI=1`;
        }

        function truncateArtist(name) {
            if (name.length <= 7) return name;
            return `${name.slice(0, 7)}â€¦`;
        }

        function setLastPlayed(card, history) {
            const songId = card.getAttribute('data-song-id');
            const lastClickText = card.querySelector('.last-click-text');
            if (history[songId]) {
                const dateRecorded = history[songId];
                const monthAgoMs = 30 * 24 * 60 * 60 * 1000;
                const isOlderThanMonth = Date.now() - dateRecorded >= monthAgoMs;

                if (isOlderThanMonth) {
                    const dateLabel = formatDateOnly(dateRecorded);
                    lastClickText.textContent = dateLabel;
                } else {
                    const weekDescription = formatWeekDescription(dateRecorded);
                    lastClickText.textContent = weekDescription;
                }
            } else {
                lastClickText.textContent = 'Not yet';
            }
        }

        function updateDisplay(history) {
            document.querySelectorAll('.song-card').forEach(card => setLastPlayed(card, history));
        }

        function handleSongPlay(songId, history) {
            history[songId] = Date.now();
            saveStoredObject(STORAGE_KEY, history);
            updateDisplay(history);
        }

        function getCartCount() {
            return Object.values(cart).reduce((total, item) => total + item.quantity, 0);
        }

        function getCartItemsData() {
            return Object.entries(cart).map(([id, item]) => {
                const song = songs.find(entry => entry.id === id) || {};
                return { ...item, ...song };
            });
        }

        function updateCartCountDisplay() {
            const countBadge = document.querySelector('.cart-count');
            if (countBadge) {
                countBadge.textContent = getCartCount();
            }
        }

        function renderCartItems() {
            const container = document.getElementById('cartItems');
            if (!container) return;
            container.innerHTML = '';

            const items = getCartItemsData();
            if (!items.length) {
                container.innerHTML = '<div class="cart-empty">No items yet. Tap Add to cart to build your order.</div>';
                return;
            }

            items.forEach(item => {
                const row = document.createElement('div');
                row.className = 'cart-item';

                const info = document.createElement('div');
                const title = document.createElement('h4');
                title.textContent = item.title || 'Untitled song';
                const meta = document.createElement('small');
                meta.textContent = `${item.number || ''} ${item.artist || ''}`.trim();
                info.append(title, meta);

                const controls = document.createElement('div');
                const quantityInput = document.createElement('input');
                quantityInput.type = 'number';
                quantityInput.min = '1';
                quantityInput.value = item.quantity;
                quantityInput.className = 'quantity-input';
                quantityInput.addEventListener('change', () => updateQuantity(item.id, parseInt(quantityInput.value, 10)));

                const removeButton = document.createElement('button');
                removeButton.className = 'remove-item';
                removeButton.type = 'button';
                removeButton.textContent = 'Remove';
                removeButton.addEventListener('click', () => removeFromCart(item.id));

                controls.append(quantityInput, removeButton);
                row.append(info, controls);
                container.append(row);
            });
        }

        function persistCart() {
            saveStoredObject(CART_KEY, cart);
            updateCartCountDisplay();
            renderCartItems();
        }

        function addToCart(songId) {
            if (!cart[songId]) {
                cart[songId] = { id: songId, quantity: 1 };
            } else {
                cart[songId].quantity += 1;
            }
            persistCart();
        }

        function removeFromCart(songId) {
            delete cart[songId];
            persistCart();
        }

        function updateQuantity(songId, quantity) {
            if (!Number.isFinite(quantity) || quantity <= 0) {
                removeFromCart(songId);
                return;
            }
            cart[songId] = { id: songId, quantity };
            persistCart();
        }

        function toggleCart(open) {
            const panel = document.getElementById('cartPanel');
            if (!panel) return;
            panel.hidden = !open;
        }

        function renderSongs(list, history) {
            const container = document.getElementById('songsList');
            container.innerHTML = '';

            const gridClass = viewMode === 'grid' ? 'grid-card' : '';

            list.forEach(song => {
                const card = document.createElement('article');
                card.className = `song-card ${gridClass}`.trim();
                card.tabIndex = 0;
                card.setAttribute('data-song-id', song.id);

                const cover = document.createElement('div');
                cover.className = 'cover-thumb';
                const img = document.createElement('img');
                img.src = song.cover || 'covers/art.jpg';
                img.alt = '';
                cover.appendChild(img);

                const content = document.createElement('div');
                content.className = 'card-content';

                const titleGroup = document.createElement('div');
                titleGroup.className = 'title-group';

                const titleRow = document.createElement('div');
                titleRow.className = 'song-title';
                const pdfLink = document.createElement('a');
                pdfLink.href = song.pdf;
                pdfLink.className = 'pdf-link';
                pdfLink.setAttribute('data-song-id', song.id);
                pdfLink.innerHTML = `<i class="fa-solid fa-music"></i>${song.title}`;

                const songNumber = document.createElement('span');
                songNumber.className = 'song-number';
                songNumber.innerHTML = `<i class="fa-solid fa-hashtag"></i>${song.number}`;

                titleRow.append(pdfLink, songNumber);
                titleGroup.appendChild(titleRow);

                const metaRow = document.createElement('div');
                metaRow.className = 'meta-row';
                const artistFull = document.createElement('span');
                artistFull.className = 'artist-full';
                artistFull.innerHTML = `<i class="fa-solid fa-user"></i>${song.artist}`;
                const artistShort = document.createElement('span');
                artistShort.className = 'artist-short';
                artistShort.innerHTML = `<i class="fa-solid fa-user"></i>${truncateArtist(song.artist)}`;
                const genre = document.createElement('span');
                genre.innerHTML = `<i class="fa-solid fa-tag"></i>${song.genre}`;
                metaRow.append(artistFull, artistShort, genre);

                content.append(titleGroup, metaRow);

                const topActions = document.createElement('div');
                topActions.className = 'top-actions';

                const lastClicked = document.createElement('div');
                lastClicked.className = 'last-clicked';
                lastClicked.innerHTML = '<i class="fa-solid fa-clock-rotate-left"></i><span class="last-click-text">Not yet</span>';

                const actionButtons = document.createElement('div');
                actionButtons.className = 'action-buttons';

                const addToCartBtn = document.createElement('button');
                addToCartBtn.type = 'button';
                addToCartBtn.className = 'btn-white add-to-cart';
                addToCartBtn.innerHTML = '<i class="fa-solid fa-cart-plus"></i> Add to cart';
                addToCartBtn.addEventListener('click', (event) => {
                    event.stopPropagation();
                    event.preventDefault();
                    addToCart(song.id);
                    toggleCart(true);
                });

                const listenLink = document.createElement('a');
                listenLink.href = formatYoutubeLink(song.title, song.artist);
                listenLink.target = '_blank';
                listenLink.rel = 'noreferrer';
                listenLink.className = 'listen-link';
                listenLink.innerHTML = '<i class="fa-brands fa-youtube"></i>';
                listenLink.addEventListener('click', (event) => event.stopPropagation());

                actionButtons.append(addToCartBtn, listenLink);
                topActions.append(actionButtons, lastClicked);

                card.append(cover, content, topActions);

                card.addEventListener('click', () => {
                    handleSongPlay(song.id, history);
                    window.location.href = song.pdf || '#';
                });

                card.addEventListener('keydown', (event) => {
                    if (event.key === 'Enter' || event.key === ' ') {
                        event.preventDefault();
                        handleSongPlay(song.id, history);
                        window.location.href = song.pdf || '#';
                    }
                });

                pdfLink.addEventListener('click', (event) => {
                    event.stopPropagation();
                    handleSongPlay(song.id, history);
                });

                container.append(card);
            });

            updateDisplay(history);
        }

        function getFilteredSongs(query) {
            const normalized = query.trim().toLowerCase();
            const isNumberSearch = /^[0-9]/.test(normalized);

            if (!normalized) {
                return songs;
            }

            const matchedIndices = [];

            songs.forEach((song, index) => {
                const searchFields = [song.number, song.title, song.artist, song.genre, song.dataName]
                    .filter(Boolean)
                    .map(field => field.toLowerCase());

                const matchesQuery = searchFields.some(field =>
                    isNumberSearch ? field.startsWith(normalized) : field.includes(normalized)
                );

                if (matchesQuery) {
                    matchedIndices.push(index);
                }
            });

            return matchedIndices.map(index => songs[index]);
        }

        function applySearchFilter(history) {
            const query = document.getElementById('songSearch').value;
            const filteredSongs = getFilteredSongs(query);
            renderSongs(filteredSongs, history);
        }

        function updateViewToggleButtons() {
            const listButton = document.getElementById('listView');
            const gridButton = document.getElementById('gridView');

            if (!listButton || !gridButton) return;

            listButton.classList.toggle('active', viewMode === 'list');
            gridButton.classList.toggle('active', viewMode === 'grid');
        }

        function setViewMode(mode, history) {
            viewMode = mode;
            localStorage.setItem(VIEW_MODE_KEY, mode);
            updateViewToggleButtons();
            applySearchFilter(history);
        }

        async function sendOrderEmail(payload) {
            const apiKey = window.RESEND_API_KEY || '';
            const headers = { 'Content-Type': 'application/json' };
            if (apiKey) {
                headers['Authorization'] = `Bearer ${apiKey}`;
            }

            const response = await fetch('https://api.resend.com/emails', {
                method: 'POST',
                headers,
                body: JSON.stringify(payload)
            });

            if (!response.ok) {
                const message = await response.text();
                throw new Error(message || 'Resend API request failed');
            }

            return response.json();
        }

        function buildOrderSummary() {
            const items = getCartItemsData();
            return items.map(item => `${item.quantity} x ${item.title || 'Song'} (${item.number || 'N/A'})`).join('
');
        }

        document.addEventListener('DOMContentLoaded', () => {
            const history = loadStoredObject(STORAGE_KEY);

            viewMode = loadStoredString(VIEW_MODE_KEY, 'list');
            updateViewToggleButtons();
            updateCartCountDisplay();
            renderCartItems();
            renderSongs(songs, history);

            document.getElementById('songSearch').addEventListener('input', () => applySearchFilter(history));

            document.getElementById('clearSearch').addEventListener('click', () => {
                const searchInput = document.getElementById('songSearch');
                searchInput.value = '';
                searchInput.focus();
                applySearchFilter(history);
            });

            document.getElementById('listView').addEventListener('click', () => setViewMode('list', history));
            document.getElementById('gridView').addEventListener('click', () => setViewMode('grid', history));

            document.getElementById('randomSong').addEventListener('click', () => {
                const visibleCards = Array.from(document.querySelectorAll('.song-card'))
                    .filter(card => card.offsetParent !== null);

                if (!visibleCards.length) {
                    return;
                }

                visibleCards.forEach(card => card.classList.remove('random-highlight'));
                const randomCard = visibleCards[Math.floor(Math.random() * visibleCards.length)];

                randomCard.classList.add('random-highlight');
                randomCard.scrollIntoView({ behavior: 'smooth', block: 'center' });

                const link = randomCard.querySelector('.pdf-link');
                if (link) {
                    link.focus();
                }
            });

            const cartToggle = document.getElementById('cartToggle');
            cartToggle.addEventListener('click', () => {
                const panel = document.getElementById('cartPanel');
                toggleCart(panel.hidden);
            });

            document.getElementById('checkoutForm').addEventListener('submit', async (event) => {
                event.preventDefault();
                const messageBox = document.getElementById('cartMessage');
                messageBox.textContent = '';

                const items = getCartItemsData();
                if (!items.length) {
                    messageBox.textContent = 'Add at least one song before checking out.';
                    return;
                }

                const name = document.getElementById('contactName').value.trim();
                const email = document.getElementById('contactEmail').value.trim();
                const phone = document.getElementById('contactPhone').value.trim();
                const shipping = document.getElementById('shippingDetails').value.trim();

                const summary = buildOrderSummary();
                const emailPayload = {
                    from: 'orders@souweststrummers.co.nz',
                    to: ['strum@souweststrummers.co.nz'],
                    subject: 'New song book order',
                    text: `Order from ${name}
Email: ${email}
Phone: ${phone}
Shipping: ${shipping}

Items:
${summary}`
                };

                try {
                    if (window.fetch) {
                        await sendOrderEmail(emailPayload);
                    }
                    messageBox.textContent = "Your order has been submitted. We'll be in touch to confirm everything and organise payment.";
                    cart = {};
                    persistCart();
                    event.target.reset();
                } catch (error) {
                    console.error(error);
                    messageBox.textContent = "Your order has been submitted. We'll be in touch to confirm everything and organise payment. (Email delivery may require a valid Resend API key.)";
                }
            });

            const backToTop = document.getElementById('backToTop');
            const toggleBackToTop = () => {
                backToTop.classList.toggle('is-visible', window.scrollY > 100);
            };

            window.addEventListener('scroll', toggleBackToTop);
            toggleBackToTop();

            backToTop.addEventListener('click', () => {
                window.scrollTo({ top: 0, behavior: 'smooth' });
                document.getElementById('songSearch').blur();
            });
        });
    </script>

</body>
</html>
