<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Timed Chords · Light</title>
  <style>
    :root{ --bg:#ffffff; --text:#0f172a; --muted:#64748b; --line:#e5e7eb; --soft:#f8fafc; --accent:#0ea5e9; --ok:#16a34a; }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Inter,Roboto,Arial,sans-serif}
    header{position:sticky;top:0;z-index:10;background:var(--bg);border-bottom:1px solid var(--line)}
    header .bar{max-width:1100px;margin:0 auto;padding:14px 16px;display:flex;gap:12px;align-items:center;justify-content:space-between}
    header h1{font-size:16px;margin:0;font-weight:700;letter-spacing:.2px}

    .wrap{max-width:1100px;margin:0 auto;padding:16px;display:grid;grid-template-columns:360px 1fr;gap:16px}
    .card{background:var(--soft);border:1px solid var(--line);border-radius:12px;padding:14px}
    .card h2{margin:0 0 10px;font-size:13px;color:var(--muted);text-transform:uppercase;letter-spacing:.08em}

    label{display:block;font-size:12px;color:var(--muted);margin:8px 0 6px}
    input[type="file"],input[type="url"],button{width:100%;padding:10px 12px;border-radius:10px;border:1px solid var(--line);background:#fff;color:var(--text)}
    button{cursor:pointer}
    button.primary{background:#fff;border-color:#cbd5e1}
    button.primary:hover{background:#f1f5f9}
    button:disabled{opacity:.6;cursor:not-allowed}

    audio{width:100%;margin-top:6px}

    .status{display:flex;gap:6px;flex-wrap:wrap}
    .pill{display:inline-flex;align-items:center;gap:6px;padding:2px 8px;border-radius:999px;border:1px solid var(--line);background:#fff;font-size:12px;color:#334155}

    .now{display:flex;align-items:center;justify-content:space-between;gap:12px;padding:10px;border:1px solid var(--line);border-radius:12px;background:#fff}
    .now .big{font-size:22px;font-weight:800}
    .muted{color:var(--muted)}

    .lyrics{max-height:56vh;overflow:auto;border:1px solid var(--line);border-radius:12px;background:#fff}
    .lyrics .line{padding:10px 12px;border-bottom:1px dashed var(--line)}
    .lyrics .time{display:inline-block;width:64px;color:#2563eb}
    .lyrics .text{white-space:pre-wrap}
    .lyrics .active{background:#f0f9ff}

    table{width:100%;border-collapse:collapse;font-size:13px;border:1px solid var(--line);background:#fff;border-radius:12px;overflow:hidden}
    th,td{padding:8px;border-bottom:1px solid var(--line);text-align:left}
    th{color:#334155;background:#f8fafc}
    tr.current{background:#ecfdf5}

    .progress{height:6px;background:#f1f5f9;border:1px solid var(--line);border-radius:999px;overflow:hidden}
    .progress>div{height:100%;width:0%;background:linear-gradient(90deg,var(--accent),var(--ok));transition:width .1s linear}

    .note{font-size:12px;color:var(--muted)}
    .hidden{display:none}
  </style>
</head>
<body>
  <header>
    <div class="bar">
      <h1>Timed Chords (Light)</h1>
      <div class="status">
        <span class="pill">Audio: <strong id="audioStatus">none</strong></span>
        <span class="pill">Lyrics: <strong id="lrcStatus">none</strong></span>
        <span class="pill">Chords: <strong id="chordStatus">none</strong></span>
      </div>
    </div>
  </header>

  <div class="wrap">
    <!-- LEFT: Loaders & playback -->
    <section class="card">
      <h2>Audio</h2>
      <label>Upload audio (MP3/M4A/WAV)</label>
      <input id="audioFile" type="file" accept="audio/*,video/mp4" />
      <audio id="audio" controls></audio>

      <h2 style="margin-top:14px">YouTube (optional)</h2>
      <label>URL</label>
      <input id="ytUrl" type="url" placeholder="https://www.youtube.com/watch?v=..." />
      <div style="display:flex; gap:8px; margin-top:8px">
        <button id="loadYT" class="primary">Load</button>
        <button id="unloadYT" class="primary">Use audio element</button>
      </div>
      <div id="ytWrap" class="hidden" style="margin-top:8px; aspect-ratio:16/9; border:1px solid var(--line); border-radius:10px; overflow:hidden"></div>
      <p id="ytError" class="note hidden" style="margin-top:8px"></p>

      <h2 style="margin-top:14px">Files</h2>
      <label>Lyrics (.lrc)</label>
      <input id="lrcFile" type="file" accept=".lrc,text/plain" />
      <label style="margin-top:6px">Chords JSON</label>
      <input id="chordFile" type="file" accept="application/json,.json" />

      <h2 style="margin-top:14px">Playback</h2>
      <div class="progress"><div id="progressBar"></div></div>
      <div class="note" style="margin-top:8px">Space toggles play/pause.</div>
    </section>

    <!-- RIGHT: Player UI -->
    <section class="card">
      <h2>Now</h2>
      <div class="now">
        <div class="big" id="nowChord">—</div>
        <div>
          <div class="muted">Next: <span id="nextChord">—</span></div>
          <div class="muted">t=<span id="nowTime">0.00</span>s</div>
        </div>
      </div>

      <h2 style="margin-top:14px">Lyrics</h2>
      <div id="lyrics" class="lyrics"></div>

      <h2 style="margin-top:14px">Chords</h2>
      <table>
        <thead><tr><th>#</th><th>Chord</th><th>Start</th><th>End</th><th>Dur</th></tr></thead>
        <tbody id="chordTable"></tbody>
      </table>
    </section>
  </div>

  <!-- YouTube API -->
  <script>
    let ytPlayer=null, ytReady=false, useYouTube=false, lastYTid=null;
    const tag=document.createElement('script'); tag.src='https://www.youtube.com/iframe_api'; document.head.appendChild(tag);
    window.onYouTubeIframeAPIReady=function(){ ytReady=true; };
  </script>

  <script>
  // ===== Helpers =====
  var $=function(s){ return document.querySelector(s); }; var $$=function(s){ return Array.from(document.querySelectorAll(s)); };
  function fmt(n){ return (Math.round(n*100)/100).toFixed(2); }
  function mmss(v){ var m=Math.floor(v/60); var s=v-m*60; return String(m).padStart(2,'0')+":"+s.toFixed(2).padStart(5,'0'); }
  function show(el,on){ if(on===undefined) on=true; el.classList.toggle('hidden', !on); }
  function esc(s){ return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

  // Extract YT ID without regex
  function getYTId(u){ try{ var url=new URL(u); if(url.hostname.indexOf('youtu.be')>-1){ var p=url.pathname.split('/'); return p[p.length-1]||null; } var v=url.searchParams.get('v'); return v||null; } catch(e){ return null; } }

  // ===== State =====
  var lrc=[]; // [{start,end,text}]
  var chords=[]; // [{chord,start,end}]

  // ===== File loaders =====
  $('#audioFile').addEventListener('change', function(e){ var f=e.target.files&&e.target.files[0]; if(!f) return; var url=URL.createObjectURL(f); var a=$('#audio'); a.src=url; useYouTube=false; $('#audioStatus').textContent=f.name; show($('#ytWrap'), false); show($('#ytError'), false); });

  $('#lrcFile').addEventListener('change', function(e){ var f=e.target.files&&e.target.files[0]; if(!f) return; f.text().then(function(text){ lrc=parseLRC(text); $('#lrcStatus').textContent=f.name; renderLyrics(); }); });

  $('#chordFile').addEventListener('change', function(e){ var f=e.target.files&&e.target.files[0]; if(!f) return; f.text().then(function(txt){ try{ var json=JSON.parse(txt); chords=Array.isArray(json&&json.chords)? json.chords: []; }catch(err){ chords=[]; alert('Invalid chords JSON'); } $('#chordStatus').textContent=f.name; renderChordTable(); }); });

  // ===== YouTube loader with error handling =====
  $('#loadYT').addEventListener('click', function(){ var id=getYTId($('#ytUrl').value.trim()); if(!id){ alert('Could not parse YouTube video ID.'); return; } if(!ytReady){ alert('YouTube API not ready yet.'); return; } lastYTid=id; show($('#ytWrap'), true); $('#ytWrap').innerHTML='<div id="player"></div>';
    ytPlayer=new YT.Player('player',{ videoId:id, playerVars:{ rel:0, playsinline:1 }, events:{ onReady:function(){ useYouTube=true; $('#audioStatus').textContent='YouTube'; show($('#ytError'), false); }, onError:function(e){ var code=e&&e.data; var msg='YouTube video is unavailable. Try another link or upload audio.'; if(code===101||code===150) msg='This video disallows embedding. Open it on YouTube, or upload audio instead.'; if(code===100) msg='Video not found or removed.'; $('#ytError').innerHTML=esc(msg)+(lastYTid? ' <a href="https://www.youtube.com/watch?v='+lastYTid+'" target="_blank" rel="noreferrer">Open in YouTube</a>':'' ); show($('#ytError'), true); useYouTube=false; show($('#ytWrap'), false); } } }); });
  $('#unloadYT').addEventListener('click', function(){ useYouTube=false; show($('#ytWrap'), false); show($('#ytError'), false); $('#audioStatus').textContent='audio element'; });

  // ===== Controls =====
  window.addEventListener('keydown', function(e){ var tag=(document.activeElement&&document.activeElement.tagName||'').toLowerCase(); var typing=(tag==='input'||tag==='textarea'); if(e.code==='Space' && !typing){ e.preventDefault(); togglePlay(); } });
  function currentTime(){ return useYouTube&&ytPlayer? ytPlayer.getCurrentTime() : ($('#audio').currentTime||0); }
  function duration(){ return useYouTube&&ytPlayer? (ytPlayer.getDuration()||0) : ($('#audio').duration||0); }
  function play(){ if(useYouTube&&ytPlayer) ytPlayer.playVideo(); else $('#audio').play(); }
  function pause(){ if(useYouTube&&ytPlayer) ytPlayer.pauseVideo(); else $('#audio').pause(); }
  function togglePlay(){ if(useYouTube&&ytPlayer){ var s=ytPlayer.getPlayerState(); if(s===YT.PlayerState.PLAYING) pause(); else play(); } else { var a=$('#audio'); if(a.paused) a.play(); else a.pause(); } }

  // ===== LRC parsing (no regex; parses one timestamp per line like [mm:ss.xx]) =====
  function parseLRC(text){ var lines=text.split(/\r?\n/); var out=[]; for(var i=0;i<lines.length;i++){ var raw=lines[i]; var lb=raw.indexOf('['); var rb=raw.indexOf(']'); if(lb===-1||rb===-1) continue; var ts=raw.slice(lb+1, rb); var parts=ts.split(':'); if(parts.length<2) continue; var mm=parseInt(parts[0],10)||0; var ss=parseFloat(parts[1])||0; var t=mm*60+ss; var lyric=raw.slice(rb+1).trim(); if(!lyric&&i+1<lines.length){ lyric=lines[i+1].trim(); } out.push({ start:t, end:t+3, text:lyric }); } out.sort(function(a,b){return a.start-b.start;}); for(var j=0;j<out.length;j++){ out[j].end = (j<out.length-1? out[j+1].start : out[j].start+3); } return out; }

  function renderLyrics(){ var el=$('#lyrics'); if(!lrc.length){ el.innerHTML='<div class="note" style="padding:10px">Load an .lrc file to show lyrics.</div>'; return; } var html=''; for(var i=0;i<lrc.length;i++){ html+='<div class="line" data-i="'+i+'"><span class="time">'+mmss(lrc[i].start)+'</span> <span class="text">'+esc(lrc[i].text)+'</span></div>'; } el.innerHTML=html; }

  function renderChordTable(){ var tb=$('#chordTable'); if(!chords.length){ tb.innerHTML='<tr><td colspan="5" class="note">Load chords JSON.</td></tr>'; return; } var html=''; for(var i=0;i<chords.length;i++){ var c=chords[i]; html+='<tr data-i="'+i+'"><td>'+(i+1)+'</td><td><strong>'+esc(c.chord)+'</strong></td><td>'+fmt(c.start)+'</td><td>'+fmt(c.end)+'</td><td>'+fmt(c.end-c.start)+'</td></tr>'; } tb.innerHTML=html; }

  // ===== Highlight loop =====
  function loop(){ var t=currentTime(); var d=duration(); if(isFinite(t)) $('#nowTime').textContent=fmt(t); if(d>0) $('#progressBar').style.width=Math.min(100,(t/d)*100)+'%';
    if(chords.length){ var i=-1; for(var k=0;k<chords.length;k++){ if(t>=chords[k].start && t<chords[k].end){ i=k; break; } } if(i<0 && chords.length && t>=chords[chords.length-1].end) i=chords.length-1; var rows=$$('#chordTable tr'); for(var r=0;r<rows.length;r++){ rows[r].classList.toggle('current', r===i); } if(i>=0){ $('#nowChord').textContent=chords[i].chord; $('#nextChord').textContent=(i<chords.length-1? chords[i+1].chord : '—'); } else { $('#nowChord').textContent='—'; $('#nextChord').textContent='—'; } }
    if(lrc.length){ var j=-1; for(var q=0;q<lrc.length;q++){ if(t>=lrc[q].start && t<lrc[q].end){ j=q; break; } } if(j<0 && lrc.length && t>=lrc[lrc.length-1].end) j=lrc.length-1; var lines=$$('#lyrics .line'); for(var m=0;m<lines.length;m++){ lines[m].classList.toggle('active', m===j); } var el=$('#lyrics .line[data-i="'+j+'"]'); if(el){ var box=$('#lyrics'); var y=el.offsetTop; var h=el.offsetHeight; var top=box.scrollTop; var vis=top+box.clientHeight; if(y<h || y<top || y+h>vis){ box.scrollTo({ top: y-40, behavior:'smooth' }); } }
    }
    requestAnimationFrame(loop);
  }
  renderLyrics(); renderChordTable(); loop();
  </script>
</body>
</html>
